# سند فنی طراحی بازی وب دو‌نفره

این سند معماری فنی، فناوری‌ها، زیرساخت، و نقشه راه توسعه یک بازی دوبعدی وب را شرح می‌دهد. سطح محتوا مناسب یک مهندس IT است.

## 1) معرفی پروژه
### 1.1 هدف
- ساخت بازی دوبعدی تحت وب با دو حالت: تک‌نفره (بازیکن در برابر AI) و دونفره آنلاین (Real-time Multiplayer).
- هر ساید یک قلعه دارد؛ با ارسال یونیت‌ها و درگیری خودکار، هدف نابودی قلعه حریف است.

### 1.2 ویژگی‌های کلیدی گیم‌پلی
- یونیت‌های متنوع با قابلیت‌های متفاوت.
- آزادسازی تدریجی یونیت‌ها بر اساس سطح بازیکن.
- سیستم دمیج، زره، برد، AoE، سرعت حمله و کول‌داون.
- انیمیشن، صدا و UX مناسب وب.

### 1.3 معیارهای موفقیت MVP
- اجرای روان در مرورگرهای مدرن (60 FPS در کلاینت).
- تأخیر قابل تحمل در حالت آنلاین (زیر 200ms).
- حداقل 1 یونیت قابل بازی + 1 لِین + یک حالت تک‌نفره ساده.

## 2) نیازمندی‌ها
### 2.1 عملکردی
- ایجاد/جوین روم، ارسال یونیت، شروع/پایان بازی.
- سیستم نبرد خودکار (حرکت، برخورد، دمیج، مرگ).
- حساب کاربری، سطح بازیکن و آزادسازی یونیت‌ها.

### 2.2 غیرعملکردی
- عملکرد: 20–30Hz سرور تیک، Sync پایدار.
- امنیت: اعتبارسنجی کامل سمت سرور، Rate limit.
- مقیاس: پشتیبانی از 500 کاربر همزمان در MVP توسعه‌یافته.

## 3) معماری کلان
```
[ Browser (Phaser) ]
        |
    WebSocket
        |
[ Colyseus Game Server ]
        |
-----------------------------
| PostgreSQL | Redis Cache |
-----------------------------
```

## 4) ساختار پروژه (پیشنهادی)
### 4.1 کلاینت
```
client/
  src/
    scenes/
    entities/
    ui/
    network/
    assets/
    config/
  index.html
```

### 4.2 سرور
```
server/
  rooms/
  schemas/
  systems/
  ai/
  config/
  index.ts
```

## 5) کلاینت (Frontend Game Client)
### 5.1 تکنولوژی‌ها
- TypeScript
- Phaser 3
- Vite
- Howler.js
- HTML/CSS برای UI Overlay

### 5.2 مسئولیت‌ها
- رندرینگ صحنه‌ها و انیمیشن‌ها.
- دریافت State از سرور و اعمال آن.
- ارسال ورودی‌ها (join_room, spawn_unit) به سرور.

## 6) سرور بازی (Authoritative)
### 6.1 تکنولوژی‌ها
- Node.js (LTS)
- Colyseus
- WebSocket
- Tick Rate: 20–30Hz

### 6.2 مسئولیت‌ها
- مالک منطق بازی (authoritative).
- مدیریت Roomها و Matchmaking.
- محاسبه حرکت، برخورد، دمیج و مرگ یونیت‌ها.
- جلوگیری از تقلب و اعتبارسنجی ورودی‌ها.

## 7) پایگاه داده و کش
### 7.1 PostgreSQL (داده‌های پایدار)
- پروفایل بازیکن
- Level و XP
- Unlock یونیت‌ها
- تاریخچه مسابقات

### 7.2 Redis (وضعیت‌های موقتی)
- وضعیت روم‌های فعال
- cooldownها و تایمرها
- TTL برای داده‌های موقتی

## 8) مدل داده یونیت‌ها
### 8.1 نمونه مدل یونیت
```json
{
  "id": "archer",
  "unlockedLevel": 2,
  "damage": 15,
  "hp": 60,
  "armor": 5,
  "range": 120,
  "aoeRadius": 0,
  "moveSpeed": 70,
  "attackSpeed": 1.2,
  "cooldown": 5,
  "cost": 10
}
```

## 9) شبکه و همگام‌سازی
### 9.1 پیام‌های کلاینت به سرور
- `join_room`
- `spawn_unit`

### 9.2 همگام‌سازی State
- Patch-based Sync (Colyseus)
- Snapshot دوره‌ای برای جلوگیری از drift
- تحمل تاخیر حدود 200ms

## 10) هوش مصنوعی تک‌نفره
### 10.1 نسخه اول
- Rule-based AI
- تصمیم‌گیری بر اساس شرایط میدان و منابع

### 10.2 نسخه پیشرفته
- Behavior Tree
- تنظیم سطح دشواری با پارامترهای ساده

## 11) امنیت و ضدتقلب
- اعتبارسنجی کامل ورودی‌ها در سرور
- Rate limiting و محافظت DDOS (Cloudflare)
- محدودیت تعداد درخواست در ثانیه

## 12) DevOps و استقرار
### 12.1 ابزارها
- Docker
- GitHub Actions (CI/CD)

### 12.2 سرویس‌ها
- Frontend: Vercel
- Game Server: Render یا Fly.io
- Database: Supabase (PostgreSQL)
- Cache: Upstash Redis
- CDN & DNS: Cloudflare

## 13) مانیتورینگ و کیفیت
- Sentry (Client & Server)
- Logging: pino
- Metrics: Prometheus (در مقیاس بالا)

## 14) نقشه راه توسعه
### فاز 1: Prototype
- یک لِین
- یک یونیت
- برخورد ساده

### فاز 2: Core Gameplay
- چند یونیت
- اقتصاد و cooldown
- UI کامل

### فاز 3: Multiplayer
- Room matchmaking
- Sync پایدار

### فاز 4: Progression
- XP
- Unlock یونیت‌ها
- AI پیشرفته

## 15) برآورد مقیاس و هزینه
- MVP: تقریبا صفر دلار
- 500 کاربر همزمان: یک سرور Node متوسط ~ 100 دلار
- مقیاس افقی با افزایش instanceها

## 16) جمع‌بندی
این معماری مقیاس‌پذیر، ضدتقلب، مناسب وب و قابل توسعه در بلندمدت است و پایه‌ای مطمئن برای ساخت بازی استراتژیک دوبعدی آنلاین فراهم می‌کند.
